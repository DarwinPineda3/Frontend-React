import {
  Box,
  Button,
  Grid,
  Table,
  TableBody,
  TableCell,
  TableRow,
  Typography,
  useTheme,
} from '@mui/material';
import { useEffect, useMemo, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useParams } from 'react-router-dom';
import DashboardCard from 'src/components/shared/DashboardCard';
import Loader from 'src/components/shared/Loader/Loader';
import { useDispatch, useSelector } from 'src/store/Store';
import { fetchNetworkScanReportDetail } from 'src/store/vulnerabilities/network/NetworkScansSlice';
import { NetworkScanReportDetail } from 'src/types/vulnerabilities/network/networkScansType';

interface VulnerabilityDetailProps {
  reportID: string;
  scanID: string;
}

const VulnerabilityDetailView: React.FC<VulnerabilityDetailProps> = ({ reportID, scanID }) => {
  const [isLoading, setIsLoading] = useState(false);
  const { vulnerabilityId } = useParams<{ vulnerabilityId: string }>();
  const { t } = useTranslation();
  const dispatch = useDispatch();
  const theme = useTheme();

  const criticalColor = theme.palette.level.critical;
  const highColor = theme.palette.level.high;
  const mediumColor = theme.palette.level.medium;
  const lowColor = theme.palette.level.low;
  const noneColor = theme.palette.level.none;
  const networkScanReportDetail: NetworkScanReportDetail = useSelector(
    (state: any) => state.networkScanReducer.networkScanReportDetail,
  );

  const vulnerabilityData = useMemo(() => {
    if (networkScanReportDetail?.report?.report.results && vulnerabilityId) {
      return networkScanReportDetail.report.report.results.find(
        (vuln: any) => vuln.result.id === vulnerabilityId,
      );
    }
    return null;
  }, [networkScanReportDetail, vulnerabilityId]);

  useEffect(() => {
    const fetchData = async () => {
      setIsLoading(true);
      try {
        await dispatch(fetchNetworkScanReportDetail(scanID, reportID));
      } catch (error) {
        console.error('error', error);
      } finally {
        setIsLoading(false);
      }
    };
    fetchData();
  }, [dispatch, scanID, reportID]);

  if (isLoading || !vulnerabilityData) {
    return (
      <Box display="flex" justifyContent="center" alignItems={'center'} mt={4} mb={4}>
        <Loader />
      </Box>
    );
  }

  const getColorSeverity = (severity: number) => {
    if (severity > 9.0) {
      return { color: criticalColor };
    } else if (severity > 7.0) {
      return { color: highColor };
    } else if (severity > 4.0) {
      return { color: mediumColor };
    } else if (severity > 0) {
      return { color: lowColor };
    } else {
      return { color: noneColor };
    }
  };

  const { severity, name, threat, nvt, host, qod, description } = vulnerabilityData.result;
  console.log(vulnerabilityData.result);
  const severityColor = getColorSeverity(severity);
  const product = host.details.find((obj) => obj['name'] == 'App');
  return (
    <Grid container spacing={3}>
      {/* Vulnerability Header */}
      <Grid item xs={12}>
        <DashboardCard>
          <Box p={2}>
            <Typography variant="h5" fontWeight="bold" sx={{ color: severityColor.color }}>
              {t('vulnerabilities.severity_cvss', { severity: threat, cvss: severity })}
            </Typography>
            <Typography variant="h6" fontWeight="bold">
              {t('vulnerabilities.vulnerability_name', { name })}
            </Typography>

            <Box mt={2}>
              <Button variant="contained" color="primary" sx={{ mr: 2 }}>
                {t('vulnerabilities.translate_button')}
              </Button>
              <Button variant="contained" color="error">
                {t('vulnerabilities.manage_vulnerability_button')}
              </Button>
            </Box>
          </Box>
        </DashboardCard>
      </Grid>

      {/* Vulnerability Details */}
      <Grid item xs={12}>
        <DashboardCard>
          <Box p={2}>
            <Table>
              <TableBody>
                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.product')}:</strong>
                  </TableCell>
                  <TableCell>{product?.value || 'NA'}</TableCell>
                </TableRow>
                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.product_detection_result')}:</strong>
                  </TableCell>
                  <TableCell>OID: {product?.source.name || 'NA'}</TableCell>
                </TableRow>
                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.summary')}:</strong>
                  </TableCell>
                  <TableCell>{nvt.tags.summary || 'NA'}</TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.detection_quality')}:</strong>
                  </TableCell>
                  <TableCell>{qod.value || 'NA'}</TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.detection_result')}:</strong>
                  </TableCell>
                  <TableCell>{description || 'NA'}</TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.solution')}:</strong>
                  </TableCell>
                  <TableCell>
                    Type: {nvt.solution.type || 'NA'}
                    <br />
                    {nvt.solution.id || ''}
                  </TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.software_affected')}:</strong>
                  </TableCell>
                  <TableCell>{nvt.solution.type || 'NA'}</TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.vulnerability_info')}:</strong>
                  </TableCell>
                  <TableCell>{nvt.tags.summary || 'NA'}</TableCell>
                </TableRow>

                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.detection_method')}:</strong>
                  </TableCell>
                  <TableCell>{nvt.tags.vuldetect || 'NA'}</TableCell>
                </TableRow>
                <TableRow>
                  <TableCell>
                    <strong>{t('vulnerabilities.references')}:</strong>
                  </TableCell>
                  <TableCell>
                    {Array.isArray(nvt.refs) && nvt.refs.length > 0 ? (
                      nvt.refs.map((ref: { type: string; id: string }, index: number) => (
                        <div key={index}>
                          <strong>
                            {ref.type} - {ref.id}
                          </strong>
                        </div>
                      ))
                    ) : (
                      <div>No references available</div>
                    )}
                  </TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </Box>
        </DashboardCard>
      </Grid>
    </Grid>
  );
};

export default VulnerabilityDetailView;
